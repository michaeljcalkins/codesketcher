<!DOCTYPE html>
<html lang="en" ng-app="codesketcher" ng-controller="AppCtrl as appCtrl">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="">

  <!-- Vendor  CSS -->
  <link href='https://fonts.googleapis.com/css?family=Lato:400,400italic,700,700italic' rel='stylesheet'>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="css/app.min.css" rel="stylesheet">
</head>
<body class="sketch-styles">
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="header-title-bar" id="display-project-path"></div>
    <div class="container-fluid">
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav text-center">
          <li>
            <a id="open-file">
              <i class="fa fa-folder"></i>
              Open
            </a>
          </li>
          <li class="dropdown pointer">
            <a class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-plus-square"></i>
              Create <span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
              <li id="create-component-class" title="Create a component class (React.Component)">
                <a>Component Class</a>
              </li>
              <li id="create-component-function" title="Create a component function">
                <a>Component Function</a>
              </li>
              <li class="divider"></li>
              <li id="create-component-class" title="Create a redux component class (React.Component)">
                <a>Redux Component Class</a>
              </li>
              <li id="create-component-function" title="Create a redux component function">
                <a>Redux Component Function</a>
              </li>
              <li class="divider"></li>
              <li id="create-component-class" title="Create a mobx component class (React.Component)">
                <a>Mobx Component Class</a>
              </li>
              <li id="create-component-function" title="Create a mobx component function">
                <a>Mobx Component Function</a>
              </li>
            </ul>
          </li>
          <li>
            <a>
              <i class="fa fa-clone"></i>
              Duplicate
            </a>
          </li>
          <li>
            <a id="save-file">
              <i class="fa fa-save"></i>
              Save
            </a>
          </li>
          <li style="width: 50px;"></li>
          <li>
            <a class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-code"></i>
              Add Function
            </a>
          </li>
          <li>
            <a class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-puzzle-piece"></i>
              Add Import
            </a>
          </li>
          <li>
            <a class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-folder"></i>
              Add Property
            </a>
          </li>
          <li>
            <a class="dropdown-toggle" data-toggle="dropdown">
              <i class="fa fa-list"></i>
              Add State
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="left-sidebar">
    <div class="sidebar-group component-constructor-container">
      <div class="pane-header">
        Constructor
      </div>
      <div class="pane-row">
        <div class="form-column full-width">
          <textarea class="form-control" id="component-render-function-input" rows="4"></textarea>
        </div>
      </div>
    </div>

    <div class="sidebar-group component-functions-container">
      <div class="pane-header">
        Functions
        <div class="btn-group pull-right">
          <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li><a href="#">constructor</a></li>
            <li><a href="#">componentWillMount</a></li>
            <li><a href="#">componentDidMount</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="#">componentWillReceiveProps</a></li>
            <li><a href="#">shouldComponentUpdate</a></li>
            <li><a href="#">componentWillUpdate</a></li>
            <li><a href="#">componentDidUpdate</a></li>
            <li><a href="#">componentWillUnmount</a></li>
          </ul>
        </div>
        <button class="btn btn-default btn-xs pull-right mr1">+</button>
      </div>
      <div class="pane-row component-function-container">
        <div class="form-column full-width">
          <textarea class="form-control component-function-input" rows="4"></textarea>
        </div>
      </div>
    </div>

    <div class="sidebar-group component-render-container">
      <div class="pane-header">
        Render
      </div>
      <div class="pane-row">
        <div class="form-column full-width">
          <textarea class="form-control" id="component-render-function-input" rows="4"></textarea>
        </div>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="sidebar-group h75">
      <div class="pane-header bt0">
        Preview
      </div>
      <div class="align-middle h100">
        <div id="component-preview"></div>
      </div>
    </div>
    <div class="row h25">
      <div class="col-sm-6 h100 br1">
        <div class="sidebar-group h100">
          <div class="pane-header">
            Properties Seed Data
          </div>
          <div class="component-properties-seed-data-container"></div>
        </div>
      </div>
      <div class="col-sm-6 h100">
        <div class="sidebar-group h100">
          <div class="pane-header">
            State Seed Data
          </div>
          <div class="component-states-seed-data-container"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="right-sidebar">
    <div class="sidebar-group">
      <div class="pane-header">
        Settings
        <button class="btn btn-default btn-xs pull-right">+</button>
      </div>

      <div class="pane-row component-name-container">
        <div class="form-column form-label">
          Name
        </div>
        <div class="form-column text-center two-thirds">
          <input class="component-name" type="text" value="" />
        </div>
      </div>
    </div>

    <div class="sidebar-group component-imports-container">
      <div class="pane-header">
        Imports
        <button class="btn btn-default btn-xs pull-right">+</button>
      </div>
    </div>

    <div class="sidebar-group component-properties-container">
      <div class="pane-header">
        Properties
        <button class="btn btn-default btn-xs pull-right">+</button>
      </div>
    </div>

    <div class="sidebar-group component-states-container">
      <div class="pane-header">
        States
        <button class="btn btn-default btn-xs pull-right">+</button>
      </div>
    </div>
  </div>

  <!-- CDN Scripts -->
  <script>var jQuery = $ = require('jQuery')</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script>!function(e,t){if("function"==typeof define&&define.amd)define(["exports","module"],t);else if("undefined"!=typeof exports&&"undefined"!=typeof module)t(exports,module);else{var n={exports:{}};t(n.exports,n),e.autosize=n.exports}}(this,function(e,t){"use strict";function n(e){function t(){var t=window.getComputedStyle(e,null);"vertical"===t.resize?e.style.resize="none":"both"===t.resize&&(e.style.resize="horizontal"),s="content-box"===t.boxSizing?-(parseFloat(t.paddingTop)+parseFloat(t.paddingBottom)):parseFloat(t.borderTopWidth)+parseFloat(t.borderBottomWidth),isNaN(s)&&(s=0),l()}function n(t){var n=e.style.width;e.style.width="0px",e.offsetWidth,e.style.width=n,e.style.overflowY=t}function o(e){for(var t=[];e&&e.parentNode&&e.parentNode instanceof Element;)e.parentNode.scrollTop&&t.push({node:e.parentNode,scrollTop:e.parentNode.scrollTop}),e=e.parentNode;return t}function r(){var t=e.style.height,n=o(e),r=document.documentElement&&document.documentElement.scrollTop;e.style.height="auto";var i=e.scrollHeight+s;return 0===e.scrollHeight?void(e.style.height=t):(e.style.height=i+"px",u=e.clientWidth,n.forEach(function(e){e.node.scrollTop=e.scrollTop}),void(r&&(document.documentElement.scrollTop=r)))}function l(){r();var t=Math.round(parseFloat(e.style.height)),o=window.getComputedStyle(e,null),i=Math.round(parseFloat(o.height));if(i!==t?"visible"!==o.overflowY&&(n("visible"),r(),i=Math.round(parseFloat(window.getComputedStyle(e,null).height))):"hidden"!==o.overflowY&&(n("hidden"),r(),i=Math.round(parseFloat(window.getComputedStyle(e,null).height))),a!==i){a=i;var l=d("autosize:resized");try{e.dispatchEvent(l)}catch(e){}}}if(e&&e.nodeName&&"TEXTAREA"===e.nodeName&&!i.has(e)){var s=null,u=e.clientWidth,a=null,p=function(){e.clientWidth!==u&&l()},c=function(t){window.removeEventListener("resize",p,!1),e.removeEventListener("input",l,!1),e.removeEventListener("keyup",l,!1),e.removeEventListener("autosize:destroy",c,!1),e.removeEventListener("autosize:update",l,!1),Object.keys(t).forEach(function(n){e.style[n]=t[n]}),i.delete(e)}.bind(e,{height:e.style.height,resize:e.style.resize,overflowY:e.style.overflowY,overflowX:e.style.overflowX,wordWrap:e.style.wordWrap});e.addEventListener("autosize:destroy",c,!1),"onpropertychange"in e&&"oninput"in e&&e.addEventListener("keyup",l,!1),window.addEventListener("resize",p,!1),e.addEventListener("input",l,!1),e.addEventListener("autosize:update",l,!1),e.style.overflowX="hidden",e.style.wordWrap="break-word",i.set(e,{destroy:c,update:l}),t()}}function o(e){var t=i.get(e);t&&t.destroy()}function r(e){var t=i.get(e);t&&t.update()}var i="function"==typeof Map?new Map:function(){var e=[],t=[];return{has:function(t){return e.indexOf(t)>-1},get:function(n){return t[e.indexOf(n)]},set:function(n,o){e.indexOf(n)===-1&&(e.push(n),t.push(o))},delete:function(n){var o=e.indexOf(n);o>-1&&(e.splice(o,1),t.splice(o,1))}}}(),d=function(e){return new Event(e,{bubbles:!0})};try{new Event("test")}catch(e){d=function(e){var t=document.createEvent("Event");return t.initEvent(e,!0,!1),t}}var l=null;"undefined"==typeof window||"function"!=typeof window.getComputedStyle?(l=function(e){return e},l.destroy=function(e){return e},l.update=function(e){return e}):(l=function(e,t){return e&&Array.prototype.forEach.call(e.length?e:[e],function(e){return n(e,t)}),e},l.destroy=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],o),e},l.update=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],r),e}),t.exports=l});</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="index.js"></script>

  <script>
    var _ = require('lodash')

    var reactInstance = null
    var componentInstance = null
    var compiledComponent = null
    var debouncedRenderComponent = _.debounce(renderComponent, 300)
    function renderComponent () {
      var importsString = ''
      $('.component-import-container').each(function (index, elem) {
        importsString += 'import ' + $(elem).find('div:first-child input').val() + ' from \'' + $(elem).find('div:nth-child(2) input').val() + '\'\n'
      })

      var renderFunctionString = $('.component-render-container textarea').val()
      var constructorFunctionString = $('.component-constructor-container textarea').val()
      var functionsString = ''
      var functionInputs = $('.component-function-input').each(function (index, elem) {
        functionsString += $(elem).val()
      })
      var componentName = $('.component-name').val()

      var propTypesString = ''
      $('.component-property-container').each(function (index, elem) {
        propTypesString += $(elem).find('div:first-child input').val() + ': PropTypes.' + $(elem).find('div:nth-child(2) input').val() + ',\n'
      })

      var statesString = ''
      $('.component-state-container').each(function (index, elem) {
        statesString += $(elem).find('div:first-child input').val() + ': ' + $(elem).find('div:nth-child(2) input').val() + ',\n'
      })

      var defaultPropsString = ''
      $('.component-property-container').each(function (index, elem) {
        if (!$(elem).find('div:last-child input').val()) return
        defaultPropsString += $(elem).find('div:first-child input').val() + ': \'' + $(elem).find('div:nth-child(3) input').val() + '\',\n'
      })

      compiledComponent = `
      ${importsString}

      export default class ${componentName} extends Component {
        ${constructorFunctionString}
        ${functionsString}
        ${renderFunctionString}
      }

      ${componentName}.state = {
        ${statesString}
      }

      ${componentName}.propTypes = {
        ${propTypesString}
      }

      ${componentName}.defaultProps = {
        ${defaultPropsString}
      }
      `

      var fs = require('fs')
      var babel = require("babel-core")
      var ReactDOM = require('react-dom')
      var React = require('react')

      try {
        babelResult = babel.transform(compiledComponent, {
          presets: ['latest', 'react']
        })

        fs.writeFileSync('temp-component.js', babelResult.code)

        // Clear the node require cache and reload the file
        delete require.cache[require.resolve('../../temp-component.js')]
        var transpiledReactComponent = require('../../temp-component.js').default

        // Container for the react component
        var componentPreviewElement = document.getElementById('component-preview')

        if (componentInstance) {
          ReactDOM.unmountComponentAtNode(document.getElementById('component-preview'))
        }

        // Get seed data for properties if there is any
        var componentPropValues = {}
        $('.component-properties-seed-data-container .pane-row').each(function (el) {
          var key = $(this).find('.form-label').text().trim()
          var value = $(this).find('input').val()
          if (value.length === 0) return
          componentPropValues[key] = value
        })

        componentInstance = ReactDOM.render(
          React.createElement(transpiledReactComponent, componentPropValues),
          componentPreviewElement
        )
      }
      catch (e) {
        console.error(e)
      }
    }

    $('.right-sidebar').resizable({
      handles: 'w'
    })

    $('.left-sidebar').resizable({
      handles: 'e'
    })

    $('#open-file').on('click', function() {
      autosize.destroy(document.querySelectorAll('textarea'));
      $('input, textarea').off('keyup')

      var dialog = require('electron').remote.dialog
      var openFilePath = dialog.showOpenDialog({
        properties: ['openFile']
      })
      if (!openFilePath) return

      $('input,textarea').val('')
      $('input').attr('checked', false)

      var fs = require('fs')
      var path = require('path')
      var filename = path.basename(openFilePath)
      var contents = fs.readFileSync(openFilePath[0], {encoding: 'utf-8'})
      var openedComponentName = filename.replace('.js', '').replace('.jsx', '')

      $('.component-name-container input').val(openedComponentName)

      /**
       * Constructor
       */
      var getConstructorFragment = require('./js/getConstructorFragment')
      var constructorFragment = getConstructorFragment(contents, openedComponentName)
      $('.component-constructor-container textarea').val(constructorFragment)

      /**
       * Render
       */
      var getRenderFragment = require('./js/getRenderFragment')
      var renderFragment = getRenderFragment(contents, openedComponentName)
      $('.component-render-container textarea').val(renderFragment)

      /**
       * Functions
       */
      $('.component-function-container').remove()
      var getFunctionFragments = require('./js/getFunctionFragments')
      var functionFragments = getFunctionFragments(contents, openedComponentName)
      functionFragments.forEach(function (fragment) {
        if (fragment.indexOf('constructor (props') > -1) return
        if (fragment.indexOf('render (') > -1) return

        $('.component-functions-container').append(`
          <div class="pane-row component-function-container">
            <div class="form-column full-width">
              <textarea class="form-control component-function-input" rows="4">${fragment}</textarea>
            </div>
          </div>
        `)
      })

      /**
       * Properties
       */
      $('.component-property-container').remove()
      var getPropertyFragments = require('./js/getPropertyFragments')
      var propertyFragments = getPropertyFragments(contents, openedComponentName)
      propertyFragments.forEach(function (fragment) {
        $('.component-properties-container').append(`
          <div class="pane-row component-property-container">
            <div class="form-column one-fourth">
              <input type="text" placeholder="Name" value="${fragment.name}" />
            </div>
            <div class="form-column one-fourth">
              <input type="text" placeholder="Type" value="${fragment.type}" />
            </div>
            <div class="form-column one-fourth">
              <input type="text" placeholder="Default" value="${fragment.default}" />
            </div>
            <div class="form-column one-fourth">
              <label class="checkbox">
                <input type="checkbox" placeholder="Default" checked="${fragment.required}" />
                Required
              </label>
            </div>
          </div>
        `)
      })

      /**
       * Properties Seed Data
       */
      $('.component-properties-seed-data-container div').remove()
      var getPropertyFragments = require('./js/getPropertyFragments')
      var propertyFragments = getPropertyFragments(contents, openedComponentName)
      propertyFragments.forEach(function (fragment) {
        $('.component-properties-seed-data-container').append(`
        <div class="pane-row">
          <div class="form-column form-label">
            ${fragment.name}
          </div>
          <div class="form-column text-center two-thirds">
            <input type="text" value="${fragment.default}" />
          </div>
        </div>
        `)
      })

      /**
       * Imports
       */
      $('.component-import-container').remove()
      var getImportFragments = require('./js/getImportFragments')
      var importFragments = getImportFragments(contents)
      importFragments.forEach(function (fragment) {
        $('.component-imports-container').append(`
        <div class="pane-row component-import-container">
          <div class="form-column one-half">
            <input type="text" placeholder="Variables" value="${fragment.variables}" />
          </div>
          <div class="form-column one-half">
            <input type="text" placeholder="From" value="${fragment.from}" />
          </div>
        </div>
        `)
      })

      /**
       * States
       */
      $('.component-state-container').remove()
      var getStateFragments = require('./js/getStateFragments')
      var stateFragments = getStateFragments(contents, openedComponentName)
      stateFragments.forEach(function (fragment) {
        $('.component-states-container').append(`
        <div class="pane-row component-state-container">
          <div class="form-column one-half">
            <input type="text" placeholder="Name" value="${fragment.name}" />
          </div>
          <div class="form-column one-half">
            <input type="text" placeholder="Value" value="${fragment.value}" />
          </div>
        </div>
        `)
      })

      /**
       * States Seed Data
       */
      $('.component-states-seed-data-container div').remove()
      var getStateFragments = require('./js/getStateFragments')
      var stateFragments = getStateFragments(contents, openedComponentName)
      stateFragments.forEach(function (fragment) {
        $('.component-states-seed-data-container').append(`
        <div class="pane-row">
          <div class="form-column form-label">
            ${fragment.name}
          </div>
          <div class="form-column text-center two-thirds">
            <input type="text" value="${fragment.value}" />
          </div>
        </div>
        `)
      })

      renderComponent()
      autosize(document.querySelectorAll('textarea'))
      $('input, textarea').on('keyup', function () {
        debouncedRenderComponent()
      })
    })

    $('#save-file').on('click', function() {
      var dialog = require('electron').remote.dialog
      var path = require('path')
      var fs = require('fs')
      var componentName = $('.component-name').val()

      var app = require('electron')
      console.log(app.remote)
      var newFilepath = dialog.showSaveDialog({
        defaultPath: componentName + '.js',
      })

      if (!newFilepath) return

      fs.writeFileSync(newFilepath, compiledComponent)
    })
  </script>
</body>
</html>
